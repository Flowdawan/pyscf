

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyscf.pbc.df.df_jk &mdash; PySCF 1.7.6 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">1. An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user.html">4. User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develop.html">5. Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">6. API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interface.html">7. Interfaces</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PySCF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.pbc.df.df_jk</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.pbc.df.df_jk</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright 2014-2020 The PySCF Developers. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Author: Qiming Sun &lt;osirpt.sun@gmail.com&gt;</span>
<span class="c1">#</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Density fitting with Gaussian basis</span>
<span class="sd">Ref:</span>
<span class="sd">J. Chem. Phys. 147, 164119 (2017)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyscf.pbc</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">pyscf.pbc.lib.kpts_helper</span> <span class="kn">import</span> <span class="n">is_zero</span><span class="p">,</span> <span class="n">gamma_point</span><span class="p">,</span> <span class="n">member</span>

<div class="viewcode-block" id="density_fit"><a class="viewcode-back" href="../../../../modules/pbc/df.html#pyscf.pbc.df.df_jk.density_fit">[docs]</a><span class="k">def</span> <span class="nf">density_fit</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">auxbasis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generte density-fitting SCF object</span>

<span class="sd">    Args:</span>
<span class="sd">        auxbasis : str or basis dict</span>
<span class="sd">            Same format to the input attribute mol.basis.  If auxbasis is</span>
<span class="sd">            None, auxiliary basis based on AO basis (if possible) or</span>
<span class="sd">            even-tempered Gaussian basis will be used.</span>
<span class="sd">        mesh : tuple</span>
<span class="sd">            number of grids in each direction</span>
<span class="sd">        with_df : DF object</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pyscf.pbc.df</span> <span class="kn">import</span> <span class="n">df</span>
    <span class="k">if</span> <span class="n">with_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="s1">&#39;kpts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kpts</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">kpts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">kpt</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">with_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">DF</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>
        <span class="n">with_df</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">max_memory</span>
        <span class="n">with_df</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">with_df</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">with_df</span><span class="o">.</span><span class="n">auxbasis</span> <span class="o">=</span> <span class="n">auxbasis</span>
        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">with_df</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>

    <span class="n">mf</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">with_df</span> <span class="o">=</span> <span class="n">with_df</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">_eri</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">mf</span></div>


<span class="k">def</span> <span class="nf">get_j_kpts</span><span class="p">(</span><span class="n">mydf</span><span class="p">,</span> <span class="n">dm_kpts</span><span class="p">,</span> <span class="n">hermi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kpts</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">kpts_band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">mydf</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">mydf</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mydf</span><span class="o">.</span><span class="n">has_kpts</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DF integrals for band k-points were not found </span><span class="si">%s</span><span class="s1">. &#39;</span>
                     <span class="s1">&#39;DF integrals will be rebuilt to include band k-points.&#39;</span><span class="p">,</span>
                     <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span><span class="p">)</span>
        <span class="n">mydf</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">kpts_band</span><span class="o">=</span><span class="n">kpts_band</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;Init get_j_kpts&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="n">dm_kpts</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">_format_dms</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>
    <span class="n">nset</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nao</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">auxcell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If mydf._cderi is the file that generated from another calculation,</span>
        <span class="c1"># guess naux based on the contents of the integral file.</span>
        <span class="n">naux</span> <span class="o">=</span> <span class="n">mydf</span><span class="o">.</span><span class="n">get_naoaux</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">naux</span> <span class="o">=</span> <span class="n">mydf</span><span class="o">.</span><span class="n">auxcell</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>
    <span class="n">nao_pair</span> <span class="o">=</span> <span class="n">nao</span> <span class="o">*</span> <span class="p">(</span><span class="n">nao</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">kpts_band</span><span class="p">,</span> <span class="n">input_band</span> <span class="o">=</span> <span class="n">_format_kpts_band</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">),</span> <span class="n">kpts_band</span>
    <span class="n">nband</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">)</span>
    <span class="n">j_real</span> <span class="o">=</span> <span class="n">gamma_point</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">dms</span><span class="p">)</span>

    <span class="n">dmsR</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dmsI</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rhoR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">naux</span><span class="p">))</span>
    <span class="n">rhoI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">naux</span><span class="p">))</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="p">(</span><span class="n">mydf</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kpts</span><span class="p">):</span>
        <span class="n">kptii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">kpt</span><span class="p">,</span><span class="n">kpt</span><span class="p">))</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">sign</span> <span class="ow">in</span> <span class="n">mydf</span><span class="o">.</span><span class="n">sr_loop</span><span class="p">(</span><span class="n">kptii</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p1</span><span class="o">+</span><span class="n">LpqR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#:Lpq = (LpqR + LpqI*1j).reshape(-1,nao,nao)</span>
            <span class="c1">#:rhoR[:,p0:p1] += numpy.einsum(&#39;Lpq,xqp-&gt;xL&#39;, Lpq, dms[:,k]).real</span>
            <span class="c1">#:rhoI[:,p0:p1] += numpy.einsum(&#39;Lpq,xqp-&gt;xL&#39;, Lpq, dms[:,k]).imag</span>
            <span class="n">rhoR</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lp,xp-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">dmsR</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
            <span class="n">rhoI</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lp,xp-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">dmsI</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">LpqI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rhoR</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lp,xp-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">dmsI</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
                <span class="n">rhoI</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lp,xp-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">dmsR</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
            <span class="n">LpqR</span> <span class="o">=</span> <span class="n">LpqI</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;get_j pass 1&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span>
    <span class="n">rhoR</span> <span class="o">*=</span> <span class="n">weight</span>
    <span class="n">rhoI</span> <span class="o">*=</span> <span class="n">weight</span>
    <span class="n">vjR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nband</span><span class="p">,</span><span class="n">nao_pair</span><span class="p">))</span>
    <span class="n">vjI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nband</span><span class="p">,</span><span class="n">nao_pair</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">):</span>
        <span class="n">kptii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">kpt</span><span class="p">,</span><span class="n">kpt</span><span class="p">))</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">sign</span> <span class="ow">in</span> <span class="n">mydf</span><span class="o">.</span><span class="n">sr_loop</span><span class="p">(</span><span class="n">kptii</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p1</span><span class="o">+</span><span class="n">LpqR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#:Lpq = (LpqR + LpqI*1j)#.reshape(-1,nao,nao)</span>
            <span class="c1">#:vjR[:,k] += numpy.dot(rho[:,p0:p1], Lpq).real</span>
            <span class="c1">#:vjI[:,k] += numpy.dot(rho[:,p0:p1], Lpq).imag</span>
            <span class="n">vjR</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhoR</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">LpqR</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">j_real</span><span class="p">:</span>
                <span class="n">vjI</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhoI</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">LpqR</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LpqI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vjR</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhoI</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">LpqI</span><span class="p">)</span>
                    <span class="n">vjI</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhoR</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">LpqI</span><span class="p">)</span>
            <span class="n">LpqR</span> <span class="o">=</span> <span class="n">LpqI</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;get_j pass 2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">j_real</span><span class="p">:</span>
        <span class="n">vj_kpts</span> <span class="o">=</span> <span class="n">vjR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vj_kpts</span> <span class="o">=</span> <span class="n">vjR</span> <span class="o">+</span> <span class="n">vjI</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">vj_kpts</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">vj_kpts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao_pair</span><span class="p">))</span>
    <span class="n">vj_kpts</span> <span class="o">=</span> <span class="n">vj_kpts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nband</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_format_jks</span><span class="p">(</span><span class="n">vj_kpts</span><span class="p">,</span> <span class="n">dm_kpts</span><span class="p">,</span> <span class="n">input_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_k_kpts</span><span class="p">(</span><span class="n">mydf</span><span class="p">,</span> <span class="n">dm_kpts</span><span class="p">,</span> <span class="n">hermi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kpts</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">kpts_band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">exxdiv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">mydf</span><span class="o">.</span><span class="n">cell</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">mydf</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">mydf</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exxdiv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exxdiv</span> <span class="o">!=</span> <span class="s1">&#39;ewald&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;GDF does not support exxdiv </span><span class="si">%s</span><span class="s1">. &#39;</span>
                 <span class="s1">&#39;exxdiv needs to be &quot;ewald&quot; or None&#39;</span><span class="p">,</span> <span class="n">exxdiv</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;GDF does not support exxdiv </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exxdiv</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mydf</span><span class="o">.</span><span class="n">has_kpts</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DF integrals for band k-points were not found </span><span class="si">%s</span><span class="s1">. &#39;</span>
                     <span class="s1">&#39;DF integrals will be rebuilt to include band k-points.&#39;</span><span class="p">,</span>
                     <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span><span class="p">)</span>
        <span class="n">mydf</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">kpts_band</span><span class="o">=</span><span class="n">kpts_band</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;Init get_k_kpts&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="n">dm_kpts</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">_format_dms</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>
    <span class="n">nset</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nao</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">kpts_band</span><span class="p">,</span> <span class="n">input_band</span> <span class="o">=</span> <span class="n">_format_kpts_band</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">),</span> <span class="n">kpts_band</span>
    <span class="n">nband</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">)</span>
    <span class="n">vkR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nband</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
    <span class="n">vkI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nband</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
    <span class="n">dmsR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dms</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">dmsI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dms</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="c1"># K_pq = ( p{k1} i{k2} | i{k2} q{k1} )</span>
    <span class="n">bufR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">bufI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mydf</span><span class="o">.</span><span class="n">max_memory</span><span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">make_kpt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">swap_2e</span><span class="p">):</span>
        <span class="n">kpti</span> <span class="o">=</span> <span class="n">kpts</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span>
        <span class="n">kptj</span> <span class="o">=</span> <span class="n">kpts_band</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">sign</span> <span class="ow">in</span> <span class="n">mydf</span><span class="o">.</span><span class="n">sr_loop</span><span class="p">((</span><span class="n">kpti</span><span class="p">,</span><span class="n">kptj</span><span class="p">),</span> <span class="n">max_memory</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="n">LpqR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pLqR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">bufR</span><span class="p">)</span>
            <span class="n">pLqI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">bufI</span><span class="p">)</span>
            <span class="n">tmpR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">LpqR</span><span class="p">)</span>
            <span class="n">tmpI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">LpqI</span><span class="p">)</span>
            <span class="n">pLqR</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">LpqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">pLqI</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">LpqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nset</span><span class="p">):</span>
                <span class="n">zdotNN</span><span class="p">(</span><span class="n">dmsR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ki</span><span class="p">],</span> <span class="n">dmsI</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ki</span><span class="p">],</span> <span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpR</span><span class="p">,</span> <span class="n">tmpI</span><span class="p">)</span>
                <span class="n">zdotCN</span><span class="p">(</span><span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                       <span class="n">tmpR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">tmpI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span>
                       <span class="n">sign</span><span class="p">,</span> <span class="n">vkR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">vkI</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">swap_2e</span><span class="p">:</span>
                <span class="n">tmpR</span> <span class="o">=</span> <span class="n">tmpR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="o">*</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
                <span class="n">tmpI</span> <span class="o">=</span> <span class="n">tmpI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="o">*</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nset</span><span class="p">):</span>
                    <span class="n">zdotNN</span><span class="p">(</span><span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span>
                           <span class="n">dmsR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">dmsI</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpR</span><span class="p">,</span> <span class="n">tmpI</span><span class="p">)</span>
                    <span class="n">zdotNC</span><span class="p">(</span><span class="n">tmpR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tmpI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                           <span class="n">sign</span><span class="p">,</span> <span class="n">vkR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ki</span><span class="p">],</span> <span class="n">vkI</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ki</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="n">kpts</span><span class="p">:</span>  <span class="c1"># normal k-points HF/DFT</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span>
                <span class="n">make_kpt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">make_kpt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;get_k_kpts: make_kpt ki&gt;=kj (</span><span class="si">%d</span><span class="s1">,*)&#39;</span><span class="o">%</span><span class="n">ki</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nband</span><span class="p">):</span>
                <span class="n">make_kpt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;get_k_kpts: make_kpt (</span><span class="si">%d</span><span class="s1">,*)&#39;</span><span class="o">%</span><span class="n">ki</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gamma_point</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gamma_point</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">)</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">)):</span>
        <span class="n">vk_kpts</span> <span class="o">=</span> <span class="n">vkR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vk_kpts</span> <span class="o">=</span> <span class="n">vkR</span> <span class="o">+</span> <span class="n">vkI</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
    <span class="n">vk_kpts</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span>

    <span class="k">if</span> <span class="n">exxdiv</span> <span class="o">==</span> <span class="s1">&#39;ewald&#39;</span><span class="p">:</span>
        <span class="n">_ewald_exxdiv_for_G0</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">dms</span><span class="p">,</span> <span class="n">vk_kpts</span><span class="p">,</span> <span class="n">kpts_band</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_format_jks</span><span class="p">(</span><span class="n">vk_kpts</span><span class="p">,</span> <span class="n">dm_kpts</span><span class="p">,</span> <span class="n">input_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>


<span class="c1">##################################################</span>
<span class="c1">#</span>
<span class="c1"># Single k-point</span>
<span class="c1">#</span>
<span class="c1">##################################################</span>

<div class="viewcode-block" id="get_jk"><a class="viewcode-back" href="../../../../modules/pbc/df.html#pyscf.pbc.df.df_jk.get_jk">[docs]</a><span class="k">def</span> <span class="nf">get_jk</span><span class="p">(</span><span class="n">mydf</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">hermi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kpt</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
           <span class="n">kpts_band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_j</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_k</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exxdiv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;JK for given k-point&#39;&#39;&#39;</span>
    <span class="n">vj</span> <span class="o">=</span> <span class="n">vk</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kpt</span><span class="o">-</span><span class="n">kpts_band</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
        <span class="n">kpt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kpt</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">with_k</span><span class="p">:</span>
            <span class="n">vk</span> <span class="o">=</span> <span class="n">get_k_kpts</span><span class="p">(</span><span class="n">mydf</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">hermi</span><span class="p">,</span> <span class="n">kpt</span><span class="p">,</span> <span class="n">kpts_band</span><span class="p">,</span> <span class="n">exxdiv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_j</span><span class="p">:</span>
            <span class="n">vj</span> <span class="o">=</span> <span class="n">get_j_kpts</span><span class="p">(</span><span class="n">mydf</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">hermi</span><span class="p">,</span> <span class="n">kpt</span><span class="p">,</span> <span class="n">kpts_band</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vj</span><span class="p">,</span> <span class="n">vk</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">mydf</span><span class="o">.</span><span class="n">cell</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">mydf</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">mydf</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mydf</span><span class="o">.</span><span class="n">has_kpts</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DF integrals for band k-points were not found </span><span class="si">%s</span><span class="s1">. &#39;</span>
                     <span class="s1">&#39;DF integrals will be rebuilt to include band k-points.&#39;</span><span class="p">,</span>
                     <span class="n">mydf</span><span class="o">.</span><span class="n">_cderi</span><span class="p">)</span>
        <span class="n">mydf</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">kpts_band</span><span class="o">=</span><span class="n">kpts_band</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;Init get_jk&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>

    <span class="n">dm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">_format_dms</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="p">[</span><span class="n">kpt</span><span class="p">])</span>
    <span class="n">nset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nao</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
    <span class="n">j_real</span> <span class="o">=</span> <span class="n">gamma_point</span><span class="p">(</span><span class="n">kpt</span><span class="p">)</span>
    <span class="n">k_real</span> <span class="o">=</span> <span class="n">gamma_point</span><span class="p">(</span><span class="n">kpt</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">dms</span><span class="p">)</span>
    <span class="n">kptii</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">kpt</span><span class="p">,</span><span class="n">kpt</span><span class="p">))</span>
    <span class="n">dmsR</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
    <span class="n">dmsI</span> <span class="o">=</span> <span class="n">dms</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
    <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="p">(</span><span class="n">mydf</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">mem_now</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">with_j</span><span class="p">:</span>
        <span class="n">vjR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">vjI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">with_k</span><span class="p">:</span>
        <span class="n">vkR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">vkI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nset</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">buf1R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">buf2R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">buf1I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">buf2I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">mydf</span><span class="o">.</span><span class="n">blockdim</span><span class="o">*</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">max_memory</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="s1">&#39;max_memory = </span><span class="si">%d</span><span class="s1"> MB (</span><span class="si">%d</span><span class="s1"> in use)&#39;</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">,</span> <span class="n">mem_now</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">contract_k</span><span class="p">(</span><span class="n">pLqR</span><span class="p">,</span> <span class="n">pLqI</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span>
        <span class="c1"># K ~ &#39;iLj,lLk*,li-&gt;kj&#39; + &#39;lLk*,iLj,li-&gt;kj&#39;</span>
        <span class="c1">#:pLq = (LpqR + LpqI.reshape(-1,nao,nao)*1j).transpose(1,0,2)</span>
        <span class="c1">#:tmp = numpy.dot(dm, pLq.reshape(nao,-1))</span>
        <span class="c1">#:vk += numpy.dot(pLq.reshape(-1,nao).conj().T, tmp.reshape(-1,nao))</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="n">pLqR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmpR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2R</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k_real</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nset</span><span class="p">):</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">dmsR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpR</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tmpR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">sign</span><span class="p">,</span> <span class="n">vkR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmpI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2I</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nset</span><span class="p">):</span>
                <span class="n">zdotNN</span><span class="p">(</span><span class="n">dmsR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dmsI</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nao</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmpR</span><span class="p">,</span> <span class="n">tmpI</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">zdotCN</span><span class="p">(</span><span class="n">pLqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pLqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                       <span class="n">tmpR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">tmpI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span>
                       <span class="n">sign</span><span class="p">,</span> <span class="n">vkR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vkI</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pLqI</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">thread_k</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">sign</span> <span class="ow">in</span> <span class="n">mydf</span><span class="o">.</span><span class="n">sr_loop</span><span class="p">(</span><span class="n">kptii</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">LpqR</span> <span class="o">=</span> <span class="n">LpqR</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;        load&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thread_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thread_k</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">with_j</span><span class="p">:</span>
            <span class="c1">#:rho_coeff = numpy.einsum(&#39;Lpq,xqp-&gt;xL&#39;, Lpq, dms)</span>
            <span class="c1">#:vj += numpy.dot(rho_coeff, Lpq.reshape(-1,nao**2))</span>
            <span class="n">rhoR</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lpq,xpq-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">dmsR</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">j_real</span><span class="p">:</span>
                <span class="n">LpqI</span> <span class="o">=</span> <span class="n">LpqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
                <span class="n">rhoR</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lpq,xpq-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">dmsI</span><span class="p">)</span>
                <span class="n">rhoI</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lpq,xpq-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">,</span> <span class="n">dmsI</span><span class="p">)</span>
                <span class="n">rhoI</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lpq,xpq-&gt;xL&#39;</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">,</span> <span class="n">dmsR</span><span class="p">)</span>
            <span class="n">vjR</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xL,Lpq-&gt;xpq&#39;</span><span class="p">,</span> <span class="n">rhoR</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">j_real</span><span class="p">:</span>
                <span class="n">vjR</span> <span class="o">-=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xL,Lpq-&gt;xpq&#39;</span><span class="p">,</span> <span class="n">rhoI</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">)</span>
                <span class="n">vjI</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xL,Lpq-&gt;xpq&#39;</span><span class="p">,</span> <span class="n">rhoR</span><span class="p">,</span> <span class="n">LpqI</span><span class="p">)</span>
                <span class="n">vjI</span> <span class="o">+=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xL,Lpq-&gt;xpq&#39;</span><span class="p">,</span> <span class="n">rhoI</span><span class="p">,</span> <span class="n">LpqR</span><span class="p">)</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;        with_j&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_k</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="n">LpqR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pLqR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1R</span><span class="p">)</span>
            <span class="n">pLqR</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">LpqR</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k_real</span><span class="p">:</span>
                <span class="n">pLqI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1I</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LpqI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pLqI</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">LpqI</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">thread_k</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">background_thread</span><span class="p">(</span><span class="n">contract_k</span><span class="p">,</span> <span class="n">pLqR</span><span class="p">,</span> <span class="n">pLqI</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;        with_k&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">LpqR</span> <span class="o">=</span> <span class="n">LpqI</span> <span class="o">=</span> <span class="n">pLqR</span> <span class="o">=</span> <span class="n">pLqI</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">thread_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thread_k</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">thread_k</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">with_j</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">j_real</span><span class="p">:</span>
            <span class="n">vj</span> <span class="o">=</span> <span class="n">vjR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vj</span> <span class="o">=</span> <span class="n">vjR</span> <span class="o">+</span> <span class="n">vjI</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
        <span class="n">vj</span> <span class="o">=</span> <span class="n">vj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_k</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k_real</span><span class="p">:</span>
            <span class="n">vk</span> <span class="o">=</span> <span class="n">vkR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vk</span> <span class="o">=</span> <span class="n">vkR</span> <span class="o">+</span> <span class="n">vkI</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
        <span class="k">if</span> <span class="n">exxdiv</span> <span class="o">==</span> <span class="s1">&#39;ewald&#39;</span><span class="p">:</span>
            <span class="n">_ewald_exxdiv_for_G0</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpt</span><span class="p">,</span> <span class="n">dms</span><span class="p">,</span> <span class="n">vk</span><span class="p">)</span>
        <span class="n">vk</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;sr jk&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vj</span><span class="p">,</span> <span class="n">vk</span></div>


<span class="k">def</span> <span class="nf">_format_dms</span><span class="p">(</span><span class="n">dm_kpts</span><span class="p">,</span> <span class="n">kpts</span><span class="p">):</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span>
    <span class="n">nao</span> <span class="o">=</span> <span class="n">dm_kpts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">dm_kpts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dms</span>

<span class="k">def</span> <span class="nf">_format_kpts_band</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kpts_band</span> <span class="o">=</span> <span class="n">kpts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kpts_band</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">kpts_band</span>

<span class="k">def</span> <span class="nf">_format_jks</span><span class="p">(</span><span class="n">v_kpts</span><span class="p">,</span> <span class="n">dm_kpts</span><span class="p">,</span> <span class="n">kpts_band</span><span class="p">,</span> <span class="n">kpts</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="n">kpts</span> <span class="ow">or</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v_kpts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dm_kpts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kpts_band</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v_kpts</span> <span class="o">=</span> <span class="n">v_kpts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># A temporary solution for issue 242. Looking for better way to sort out the</span>
<span class="c1"># dimension of the output</span>
<span class="c1"># dm_kpts.shape     kpts.shape     nset</span>
<span class="c1"># (Nao,Nao)         (1 ,3)         None</span>
<span class="c1"># (Ndm,Nao,Nao)     (1 ,3)         Ndm</span>
<span class="c1"># (Nk,Nao,Nao)      (Nk,3)         None</span>
<span class="c1"># (Ndm,Nk,Nao,Nao)  (Nk,3)         Ndm</span>
        <span class="k">if</span> <span class="n">dm_kpts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>     <span class="c1"># nset=None</span>
            <span class="k">return</span> <span class="n">v_kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dm_kpts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">dm_kpts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">kpts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">v_kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># dm_kpts.ndim == 4 or kpts.shape[0] == 1:  # nset=Ndm</span>
            <span class="k">return</span> <span class="n">v_kpts</span>

<div class="viewcode-block" id="zdotNN"><a class="viewcode-back" href="../../../../modules/pbc/df.html#pyscf.pbc.df.df_jk.zdotNN">[docs]</a><span class="k">def</span> <span class="nf">zdotNN</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;c = a*b&#39;&#39;&#39;</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="k">return</span> <span class="n">cR</span><span class="p">,</span> <span class="n">cI</span></div>

<div class="viewcode-block" id="zdotCN"><a class="viewcode-back" href="../../../../modules/pbc/df.html#pyscf.pbc.df.df_jk.zdotCN">[docs]</a><span class="k">def</span> <span class="nf">zdotCN</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;c = a.conj()*b&#39;&#39;&#39;</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="k">return</span> <span class="n">cR</span><span class="p">,</span> <span class="n">cI</span></div>

<div class="viewcode-block" id="zdotNC"><a class="viewcode-back" href="../../../../modules/pbc/df.html#pyscf.pbc.df.df_jk.zdotNC">[docs]</a><span class="k">def</span> <span class="nf">zdotNC</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;c = a*b.conj()&#39;&#39;&#39;</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cR</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cR</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aR</span><span class="p">,</span> <span class="n">bI</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">cI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">aI</span><span class="p">,</span> <span class="n">bR</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cI</span><span class="p">,</span> <span class="mi">1</span>   <span class="p">)</span>
    <span class="k">return</span> <span class="n">cR</span><span class="p">,</span> <span class="n">cI</span></div>

<span class="k">def</span> <span class="nf">_ewald_exxdiv_for_G0</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">dms</span><span class="p">,</span> <span class="n">vk</span><span class="p">,</span> <span class="n">kpts_band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pbc_intor</span><span class="p">(</span><span class="s1">&#39;int1e_ovlp&#39;</span><span class="p">,</span> <span class="n">hermi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kpts</span><span class="o">=</span><span class="n">kpts</span><span class="p">)</span>
    <span class="n">madelung</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">madelung</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dms</span><span class="p">):</span>
            <span class="n">vk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">madelung</span> <span class="o">*</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="k">if</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">is_zero</span><span class="p">(</span><span class="n">kpts_band</span><span class="o">-</span><span class="n">kpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dms</span><span class="p">):</span>
                <span class="n">vk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">madelung</span> <span class="o">*</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">kpts_band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">kpts</span><span class="p">,</span> <span class="n">kpts_band</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dms</span><span class="p">):</span>
                <span class="n">vk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">madelung</span> <span class="o">*</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">member</span><span class="p">(</span><span class="n">kpt</span><span class="p">,</span> <span class="n">kpts_band</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dms</span><span class="p">):</span>
                    <span class="n">vk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">kp</span><span class="p">]</span> <span class="o">+=</span> <span class="n">madelung</span> <span class="o">*</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyscf.pbc.gto</span> <span class="k">as</span> <span class="nn">pgto</span>
    <span class="kn">import</span> <span class="nn">pyscf.pbc.scf</span> <span class="k">as</span> <span class="nn">pscf</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mf">5.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">pgto</span><span class="o">.</span><span class="n">Cell</span><span class="p">()</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">])</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">])</span>

    <span class="n">cell</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;C    3.    2.       3.</span>
<span class="s1">                   C    1.    1.       1.&#39;&#39;&#39;</span>
    <span class="c1">#cell.basis = {&#39;He&#39;: [[0, (1.0, 1.0)]]}</span>
    <span class="c1">#cell.basis = &#39;631g&#39;</span>
    <span class="c1">#cell.basis = {&#39;He&#39;: [[0, (2.4, 1)], [1, (1.1, 1)]]}</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="s1">&#39;ccpvdz&#39;</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">mf</span> <span class="o">=</span> <span class="n">pscf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get_init_guess</span><span class="p">()</span>
    <span class="n">auxbasis</span> <span class="o">=</span> <span class="s1">&#39;weigend&#39;</span>
    <span class="c1">#from pyscf import df</span>
    <span class="c1">#auxbasis = df.addons.aug_etb_for_dfbasis(cell, beta=1.5, start_at=0)</span>
    <span class="c1">#from pyscf.pbc.df import mdf</span>
    <span class="c1">#mf.with_df = mdf.MDF(cell)</span>
    <span class="c1">#mf.auxbasis = auxbasis</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">density_fit</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">auxbasis</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">vj</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">get_jk</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">exxdiv</span><span class="o">=</span><span class="n">mf</span><span class="o">.</span><span class="n">exxdiv</span><span class="p">,</span> <span class="n">with_k</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">,</span> <span class="n">dm</span><span class="p">),</span> <span class="s1">&#39;ref=46.698942480902062&#39;</span><span class="p">)</span>
    <span class="n">vj</span><span class="p">,</span> <span class="n">vk</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">get_jk</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">exxdiv</span><span class="o">=</span><span class="n">mf</span><span class="o">.</span><span class="n">exxdiv</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">,</span> <span class="n">dm</span><span class="p">),</span> <span class="s1">&#39;ref=46.698942480902062&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vk</span><span class="p">,</span> <span class="n">dm</span><span class="p">),</span> <span class="s1">&#39;ref=37.348163681114187&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">(</span><span class="n">cell</span><span class="p">),</span> <span class="n">dm</span><span class="p">),</span> <span class="s1">&#39;ref=-75.5758086593503&#39;</span><span class="p">)</span>

    <span class="n">kpts</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">make_kpts</span><span class="p">([</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="kn">from</span> <span class="nn">pyscf.pbc.df</span> <span class="kn">import</span> <span class="n">DF</span>
    <span class="n">with_df</span> <span class="o">=</span> <span class="n">DF</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">kpts</span><span class="p">)</span>
    <span class="n">with_df</span><span class="o">.</span><span class="n">auxbasis</span> <span class="o">=</span> <span class="s1">&#39;weigend&#39;</span>
    <span class="n">with_df</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">dms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dm</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">))</span>
    <span class="n">vj</span><span class="p">,</span> <span class="n">vk</span> <span class="o">=</span> <span class="n">with_df</span><span class="o">.</span><span class="n">get_jk</span><span class="p">(</span><span class="n">dms</span><span class="p">,</span> <span class="n">exxdiv</span><span class="o">=</span><span class="n">mf</span><span class="o">.</span><span class="n">exxdiv</span><span class="p">,</span> <span class="n">kpts</span><span class="o">=</span><span class="n">kpts</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">46.69784067248350</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">46.69814992718212</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mf">46.69526120279135</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vj</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="mf">46.69570739526301</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">37.26974254415191</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">37.27001407288309</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mf">37.27000643285160</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ji-&gt;&#39;</span><span class="p">,</span> <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="mf">37.27010299675364</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2015-2021, The PySCF Developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>